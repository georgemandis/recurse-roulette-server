<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recurse Roulette</title>
    <script src="/js/peerjs.min.js"></script>
    <script src="/js/konami.js"></script>
    <link
      href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="style/main.css" />
  </head>
  <body>
    <nav>
      <a class="margin-x" href="/">
        <img class="logo" src="media/logo.svg" />
      </a>
      <div class="nav-container">
        <a
          class="nav-link margin-x"
          target="_blank"
          href="https://github.com/georgemandis/recurse-roulette-server"
          >Github</a
        >
      </div>
    </nav>

    <div class="content flex-column vertical-center margin-y">
      <h1 class="title margin-y">Recurse Roulette</h1>
      <h3 class="title margin-bottom" id="onlinePeers">--</h3>
      <!-- Join and End Call buttons -->
      <div class="flex-row margin-bottom">
        <!--Join the queue-->
        <button class="button margin-x-small" id="connect">Join</button>
        <!--End the call-->
        <button class="button margin-x-small" id="close" disabled>
          Hangup
        </button>
      </div>

      <!-- video streams -->
      <div class="flex-row">
        <!--Video stream for me-->
        <div class="flex-column">
          <video
            class="margin-bottom"
            id="me"
            autoplay="autoplay"
            muted
          ></video>
          <div class="flex-row">
            <button
              class="button margin-bottom margin-x-small"
              disabled
              id="muteButton"
            >
              Mute
            </button>
            <button
              class="button margin-bottom margin-x-small"
              disabled
              id="videoButton"
            >
              Stop Video
            </button>
          </div>
        </div>
        <!--Video stream for connect peer-->
        <div>
          <div class="flex-column">
            <video class="margin-bottom" id="you" autoplay="autoplay"></video>
            <span id="peerMutedSpan">Muted</span>
          </div>
        </div>
      </div>

      <marquee class="margin-y">
        <strong>Social Rules</strong>: 1. No well-actuallyâ€™s &nbsp;&nbsp; 2. No
        feigning surprise &nbsp;&nbsp; 3. No backseat driving &nbsp;&nbsp; 4. No
        subtle -isms
      </marquee>
    </div>

    <script>
      const me = document.querySelector("#me");
      const you = document.querySelector("#you");
      let myPeerID, yourPeerID, stream, peer, waitForPeer, peerCall, peerCon;

      let state = {
        isMuted: false
      };

      //query selectors used throughout code
      const peerMutedSpan = document.querySelector("#peerMutedSpan");
      const onlinePeersSpan = document.querySelector("#onlinePeers");
      //buttons
      const muteButton = document.querySelector("#muteButton");
      const videoButton = document.querySelector("#videoButton");
      const connectButton = document.querySelector("#connect");
      const hangupButton = document.querySelector("#close");

      const checkForOnlinePeers = setInterval(async () => {
        const currentOnlinePeers = await (await fetch("/api/online")).json();
        onlinePeersSpan.textContent = `${currentOnlinePeers} Recurser${
          currentOnlinePeers === 1 ? "" : "s"
        } Online`;
      }, 1000);

      //Button Event Listeners
      connectButton.addEventListener("click", makeConnection);
      //mute and audio buttons
      muteButton.addEventListener("click", () => {
        modifyStream("audio", event.target);
      });
      videoButton.addEventListener("click", () =>
        modifyStream("video", event.target)
      );

      hangupButton.addEventListener("click", () => {
        if (you.srcObject === null) {
          return false;
        }

        peerCall.close();
        peerConn.close();
        console.log("Initiating hangup");

        you.srcObject = null;
        connectButton.removeAttribute("disabled");
      });

      //fetches an available peer from the API endpoint
      async function startRoulette() {
        const getPeers = await fetch("/api/peers");
        const availablePeers = new Set(await getPeers.json());

        availablePeers.delete(myPeerID);

        const firstAvailablePeer = availablePeers.values().next().value;
        peerCall = peer.call(firstAvailablePeer, stream);
        peerConn = peer.connect(firstAvailablePeer);

        peerCall.on("stream", handleStream);
        peerCall.on("close", handleClose);

        peerConn.on("open", () => peerConn.send(state));
        peerConn.on("data", handleConnection);
      }

      async function makeConnection() {
        connectButton.disabled = true;
        muteButton.removeAttribute("disabled");
        videoButton.removeAttribute("disabled");

        if (!peer) {
          stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
          });
          console.log(stream);

          me.srcObject = stream;
          me.play();

          peer = new Peer({
            host: location.hostname,
            port: location.port,
            path: "/peer"
          });
        } else {
          await fetch(`/api/peers/add/${myPeerID}`);
          waitForPeer = setInterval(startRoulette, 1000);
        }

        // connect to the signaling server
        peer.on("open", function(id) {
          myPeerID = id;
          console.log("Opening conection to PeerJS", id);
          waitForPeer = setInterval(startRoulette, 1000);
        });

        //make connection to peer
        peer.on("connection", function(conn) {
          peerConn = conn;
          peerConn.on("open", () => peerConn.send(state));
          peerConn.on("data", handleConnection);
        });

        peer.on("call", async function(call) {
          peerCall = call;

          if (you.srcObject !== null) {
            console.log("call received, no srcObject");
            return false;
          }

          console.log("Receiving call");

          // answer the call
          peerCall.answer(stream);
          peerCall.on("stream", handleStream);
          peerCall.on("close", handleClose);
        });
      }

      async function handleStream(remoteStream) {
        you.srcObject = remoteStream;
        await fetch(`/api/peers/consume/${myPeerID}`);
        clearInterval(waitForPeer);
      }

      function handleClose() {
        you.srcObject = null;
        //remove muted span for peer
        peerMutedSpan.style.display = "none";
        //disable hangup button, enable connect button
        hangupButton.disabled = true;
        connectButton.removeAttribute("disabled");
        console.log("Connection closed");
      }

      function handleConnection(data) {
        //enable hangup button
        hangupButton.removeAttribute("disabled");

        if (data.isMuted) {
          peerMutedSpan.style.display = "block";
        } else {
          peerMutedSpan.style.display = "none";
        }
      }

      //event handlers for the mute and video buttons
      //streamName can be "video" or "audio"
      function modifyStream(streamName, target) {
        if (!stream) {
          return false;
        }
        //finds if the specified stream is enabled
        let isEnabled = stream
          .getTracks()
          .filter(stream => stream.kind === streamName)[0].enabled;

        //flips the value of isEnabled
        let isCurrentlyEnabled = !isEnabled;

        //toggles the stream by directly modifying the stream object
        stream
          .getTracks()
          .filter(
            stream => stream.kind === streamName
          )[0].enabled = isCurrentlyEnabled;

        //edits the HTML of the target
        if (streamName === "audio") {
          target.innerHTML = `${isCurrentlyEnabled ? "Mute" : "Unmute"}`;
          //if the audio stream is enabled, the user is not muted. So flip the value of isCurrentlyEnabled.
          let isMuted = !isCurrentlyEnabled;
          //update state and send it to the peer
          state.isMuted = isMuted;
          peerConn.send(state);
        } else if (streamName === "video") {
          target.innerHTML = `${isCurrentlyEnabled ? "Stop" : "Start"} Video`;
        }
      }

      (() => {
        const bill = new Konami(() => {
          const bills = [
            "billandbees.jpg",
            "billandirshmen.jpg",
            "billspace.jpg"
          ];
          you.poster = `/media/${
            bills[Math.floor(Math.random() * bills.length)]
          }`;
          clearInterval(checkForOnlinePeers);
          onlinePeersSpan.textContent = "Bill is Online";
          const marquee = document.querySelector("marquee");
          marquee.innerHTML =
            "<marquee scrollamount='20' behavior='alternate' style='width:30%;color:#00A0E6'>Gotta go fast!</marquee>";
        });
      })();
    </script>
  </body>
</html>
