<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recurse Roulette</title>
    <script src="/js/peerjs.min.js"></script>
    <script src="/js/konami.js"></script>
    <link
      href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="style/main.css" />
  </head>
  <body>
    <nav>
      <a class="margin-x" href="/">
        <img class="logo" src="media/logo.svg" />
      </a>
      <div class="nav-container">
        <a
          class="nav-link margin-x"
          target="_blank"
          href="https://github.com/georgemandis/recurse-roulette-server"
          >Github</a
        >
      </div>
    </nav>

    <div class="content flex-column vertical-center margin-y">
      <h1 class="title margin-y">Recurse Roulette</h1>
      <h3 class="title margin-bottom" id="onlinePeers">--</h3>
      <!-- Join and End Call buttons -->
      <div class="flex-row">
        <!--Join the queue-->
        <button class="button margin-bottom margin-x-small" id="connect">
          Join
        </button>
        <!--End the call-->
        <button class="button margin-bottom margin-x-small" id="close" disabled>
          Hang Up
        </button>
      </div>

      <!-- video streams -->
      <div class="flex-row">
        <!--Video stream for me-->
        <div class="flex-column">
          <video
            class="margin-bottom"
            id="me"
            autoplay="autoplay"
            muted
          ></video>
          <div class="flex-row">
            <button
              class="button margin-bottom margin-x-small"
              disabled
              id="muteButton"
            >
              Mute
            </button>
            <button
              class="button margin-bottom margin-x-small"
              disabled
              id="videoButton"
            >
              Stop Video
            </button>
          </div>
        </div>
        <!--Video stream for connect peer-->
        <div>
          <div class="flex-column">
            <video class="margin-bottom" id="you" autoplay="autoplay"></video>
            <span id="peerMutedSpan">Muted</span>
          </div>
        </div>
      </div>

      <marquee class="margin-y">
        <strong>Social Rules</strong>: 1. No well-actuallyâ€™s &nbsp;&nbsp; 2. No
        feigning surprise &nbsp;&nbsp; 3. No backseat driving &nbsp;&nbsp; 4. No
        subtle -isms
      </marquee>
    </div>

    <script>
      // video elements for the two streams
      const me = document.querySelector("#me");
      const you = document.querySelector("#you");
      let myPeerID, yourPeerID, stream, peer, waitForPeer, peerCall, peerConn;

      // the state keeps track of the current user's mic
      let state = {
        isMuted: false
      };

      // query selectors used throughout code
      const peerMutedSpan = document.querySelector("#peerMutedSpan");
      const onlinePeersSpan = document.querySelector("#onlinePeers");
      // buttons query selectors
      const muteButton = document.querySelector("#muteButton");
      const videoButton = document.querySelector("#videoButton");
      const connectButton = document.querySelector("#connect");
      const hangupButton = document.querySelector("#close");

      // updates how many peers are online eveyr second
      const checkForOnlinePeers = setInterval(async () => {
        const currentOnlinePeers = await (await fetch("/api/online")).json();
        onlinePeersSpan.textContent = `${currentOnlinePeers} Recurser${
          currentOnlinePeers === 1 ? "" : "s"
        } Online`;
      }, 1000);

      // mute and audio buttons
      muteButton.addEventListener("click", () => {
        modifyStream("audio", event.target);
      });
      videoButton.addEventListener("click", () =>
        modifyStream("video", event.target)
      );

      // join and hangup buttons
      connectButton.addEventListener("click", makeConnection);
      hangupButton.addEventListener("click", () => {
        if (isConnected() == false) {
          // if the roulette has started, end it and destroy the peer
          clearInterval(waitForPeer);
          peer.destroy();
          // remove loading animation, enable join button, disable hangup button
          you.classList.remove("loading");
          connectButton.removeAttribute("disabled");
          hangupButton.disabled = true;
          return false;
        }

        console.log("Initiating hangup");
        handleClose();

        you.srcObject = null;
        connectButton.removeAttribute("disabled");
      });

      // fetches an available peer from the API endpoint
      async function startRoulette() {
        // fetches all of the available peers
        const getPeers = await fetch("/api/peers");
        const availablePeers = new Set(await getPeers.json());
        // removes the current peer ID so you can't pair with yourself
        availablePeers.delete(myPeerID);
        const firstAvailablePeer = availablePeers.values().next().value;
        //initiates a call and connection
        peerCall = peer.call(firstAvailablePeer, stream);
        peerConn = peer.connect(firstAvailablePeer);

        peerCall.on("stream", handleStream);
        peerCall.on("close", handleClose);

        // sends the current state to tell the peer if the stream is muted
        peerConn.on("open", () => peerConn.send(state));
        peerConn.on("data", handleConnection);
      }

      async function makeConnection() {
        //disable join button, enable hang up mute and stop video buttons
        connectButton.disabled = true;
        hangupButton.removeAttribute("disabled");
        muteButton.removeAttribute("disabled");
        videoButton.removeAttribute("disabled");
        // add loading animation
        you.classList.add("loading");

        // initiate media stream
        if (!me.srcObject) {
          stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
          });
          console.log(stream);

          // put the stream to the HTML video object
          me.srcObject = stream;
          me.play();
        }

        if (
          peer === undefined ||
          (typeof peer === "object" && peer.destroyed)
        ) {
          setupPeer();
          console.log("I have set up a peer", peer);
        }
      }

      function setupPeer() {
        console.log("I'm going to set up a peer");
        peer = new Peer({
          host: location.hostname,
          port: location.port,
          path: "/peer"
        });

        // connect to the signaling server
        peer.on("open", function(id) {
          myPeerID = id;
          console.log("Opening conection to PeerJS", id);
          waitForPeer = setInterval(startRoulette, 1000);
        });

        // make connection to peer
        peer.on("connection", function(conn) {
          peerConn = conn;
          // sends the current state to tell the peer if the stream is muted
          peerConn.on("open", () => peerConn.send(state));
          peerConn.on("data", handleConnection);
        });

        peer.on("call", async function(call) {
          // sets the global peerCall object to the call
          peerCall = call;

          if (you.srcObject !== null) {
            console.log("call received, no srcObject");
            return false;
          }

          console.log("Receiving call");

          // answer the call and send the the current user's stream
          peerCall.answer(stream);
          peerCall.on("stream", handleStream);
          peerCall.on("close", handleClose);
        });
      }

      async function handleStream(remoteStream) {
        // remove loading animation
        you.classList.remove("loading");

        // sets the source for the video element to the incoming stream
        you.srcObject = remoteStream;
        // removes the current user's peer id from the list
        await fetch(`/api/peers/consume/${myPeerID}`);
        // ends the roulette
        clearInterval(waitForPeer);
      }

      function handleClose() {
        // remote stream to the video element
        you.srcObject = null;

        // close the connection and DESTRUCTION to the peer
        // (abandon all hope, ye who enter peer)
        peerCall.close();
        peerConn.close();
        peer.destroy();

        // remove muted span for peer
        peerMutedSpan.style.display = "none";
        // disable hangup button, enable connect button
        hangupButton.disabled = true;
        connectButton.removeAttribute("disabled");
        console.log("Connection closed");
      }

      function handleConnection(data) {
        // sends information about if the peer is muted
        if (data.isMuted) {
          peerMutedSpan.style.display = "block";
        } else {
          peerMutedSpan.style.display = "none";
        }
      }

      // event handler for the mute and video buttons
      // streamName can be "video" or "audio"
      function modifyStream(streamName, target) {
        if (!stream) {
          return false;
        }
        // finds if the specified stream is enabled
        let isEnabled = stream
          .getTracks()
          .filter(stream => stream.kind === streamName)[0].enabled;

        // flips the value of isEnabled
        let isCurrentlyEnabled = !isEnabled;

        // toggles the stream by directly modifying the stream object
        stream
          .getTracks()
          .filter(
            stream => stream.kind === streamName
          )[0].enabled = isCurrentlyEnabled;

        // edits the HTML of the target
        if (streamName === "audio") {
          target.textContent = `${isCurrentlyEnabled ? "Mute" : "Unmute"}`;
          // if the audio stream is enabled, the user is not muted. So flip the value of isCurrentlyEnabled.
          let isMuted = !isCurrentlyEnabled;
          // update the state and send it to the peer
          state.isMuted = isMuted;
          peerConn.send(state);
        } else if (streamName === "video") {
          target.textContent = `${isCurrentlyEnabled ? "Stop" : "Start"} Video`;
        }
      }
      // determine if the peer stream connected
      function isConnected() {
        return you.srcObject ? true : false;
      }

      // bill
      (() => {
        const bill = new Konami(() => {
          const bills = [
            "billandbees.jpg",
            "billandirshmen.jpg",
            "billspace.jpg"
          ];
          you.poster = `/media/${
            bills[Math.floor(Math.random() * bills.length)]
          }`;
          clearInterval(checkForOnlinePeers);
          onlinePeersSpan.textContent = "Bill is Online";
          const marquee = document.querySelector("marquee");
          marquee.innerHTML =
            "<marquee scrollamount='20' behavior='alternate' style='width:30%;color:#00A0E6'>Gotta go fast!</marquee>";
        });
      })();
    </script>
  </body>
</html>
